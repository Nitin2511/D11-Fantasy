<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T20 World Cup Fantasy Contest</title>
    <meta name="description" content="Create teams, compete with friends in T20 World Cup Fantasy Contest">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        #root { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header {
            text-align: center;
            padding: 50px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 25px;
            margin-bottom: 40px;
            box-shadow: 0 30px 60px rgba(16, 185, 129, 0.4);
            position: relative;
        }
        
        .header h1 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 4px;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.5);
        }
        
        .header p { font-size: 1.2rem; margin-top: 10px; opacity: 0.9; }
        
        .user-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .admin-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 35px;
            background: #1a1f3a;
            padding: 12px;
            border-radius: 20px;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 15px 18px;
            background: transparent;
            border: none;
            color: #8892b0;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            font-size: 14px;
            font-family: 'Rajdhani', sans-serif;
            white-space: nowrap;
        }
        
        .tab:hover { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }
        
        .card {
            background: linear-gradient(135deg, #1a1f3a 0%, #242b4a 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .card h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2rem;
            margin-bottom: 20px;
            color: #10b981;
            letter-spacing: 1px;
        }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 10px; color: #cbd5e1; font-weight: 600; }
        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            background: #0a0e27;
            border: 2px solid #2d3548;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .btn {
            padding: 15px 35px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 17px;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 1px;
        }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.6); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 10px 30px rgba(59, 130, 246, 0.6); }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .btn-danger:hover:not(:disabled) { box-shadow: 0 10px 30px rgba(239, 68, 68, 0.6); }
        
        .btn-small { padding: 10px 25px; font-size: 14px; }
        
        .error-box {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #f87171;
        }
        
        .success-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #34d399;
        }
        
        .info-box {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #22d3ee;
        }
        
        .info-box h3 { margin-bottom: 10px; font-size: 1.2rem; }
        .info-box p { margin: 5px 0; opacity: 0.9; font-size: 14px; }
        
        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            margin-top: 25px;
        }
        
        .player-card {
            background: linear-gradient(135deg, #0a0e27 0%, #151930 100%);
            border: 2px solid #2d3548;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .player-card:hover {
            border-color: #10b981;
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.3);
        }
        
        .player-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }
        
        .player-card h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .player-card .role-badge {
            display: inline-block;
            padding: 5px 12px;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 10px;
        }
        
        .player-card.selected .role-badge { background: rgba(255,255,255,0.3); color: white; }
        
        .player-card .team-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .player-card.selected .team-badge { background: rgba(255,255,255,0.3); color: white; }
        
        .player-card .stats {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            opacity: 0.8;
        }
        
        .team-summary {
            background: #0a0e27;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .team-summary h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #10b981;
        }
        
        .team-counts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .count-item {
            background: #1a1f3a;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .count-item .label { font-size: 13px; color: #94a3b8; margin-bottom: 8px; }
        .count-item .value { font-size: 1.8rem; font-weight: 700; color: #10b981; font-family: 'Rajdhani', sans-serif; }
        
        .match-card {
            background: linear-gradient(135deg, #0a0e27 0%, #151930 100%);
            border: 2px solid #2d3548;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .match-card:hover {
            border-color: #10b981;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .match-header h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.4rem;
            color: #fff;
        }
        
        .match-date {
            background: rgba(16, 185, 129, 0.2);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
        }
        
        .captain-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        
        .captain-btn {
            padding: 12px;
            background: #1a1f3a;
            border: 2px solid #2d3548;
            border-radius: 10px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .captain-btn:hover { border-color: #10b981; }
        .captain-btn.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }
        
        .captain-label {
            display: inline-block;
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
        }
        
        .vice-captain-label {
            display: inline-block;
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
        }
        
        .team-list {
            margin-top: 20px;
        }
        
        .team-list-item {
            background: #0a0e27;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-list-item .player-info { display: flex; align-items: center; gap: 12px; }
        .team-list-item .player-name { font-weight: 600; font-size: 16px; }
        .team-list-item .player-role { font-size: 13px; color: #94a3b8; }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .leaderboard-table thead {
            background: #0a0e27;
        }
        
        .leaderboard-table th {
            padding: 15px;
            text-align: left;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #10b981;
            border-bottom: 2px solid #2d3548;
        }
        
        .leaderboard-table td {
            padding: 15px;
            border-bottom: 1px solid #2d3548;
        }
        
        .leaderboard-table tbody tr:hover {
            background: rgba(16, 185, 129, 0.05);
        }
        
        .rank-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #2d3548;
            border-radius: 8px;
            font-weight: 700;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
        }
        
        .rank-badge.rank-1 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .rank-badge.rank-2 { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
        .rank-badge.rank-3 { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        
        .contest-code {
            background: #0a0e27;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
        }
        
        .contest-code-value {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #10b981;
            letter-spacing: 5px;
            margin: 10px 0;
        }
        
        .points-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .points-input-item {
            background: #0a0e27;
            padding: 15px;
            border-radius: 12px;
        }
        
        .points-input-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #cbd5e1;
        }
        
        .points-input-item input {
            width: 100%;
            padding: 10px;
            background: #1a1f3a;
            border: 2px solid #2d3548;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .users-table thead {
            background: #0a0e27;
        }
        
        .users-table th {
            padding: 15px;
            text-align: left;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: #10b981;
            border-bottom: 2px solid #2d3548;
        }
        
        .users-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #2d3548;
            font-size: 14px;
        }
        
        .users-table tbody tr:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .player-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: nowrap; overflow-x: auto; }
            .captain-selection { grid-template-columns: 1fr; }
            .user-badge { position: static; margin-top: 15px; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================
        // CONSTANTS
        // ============================================
        const PLAYERS = [
            { id: 'p1', name: 'Virat Kohli', team: 'IND', role: 'Batsman', matchRate: 0.85 },
            { id: 'p2', name: 'Rohit Sharma', team: 'IND', role: 'Batsman', matchRate: 0.80 },
            { id: 'p3', name: 'Jasprit Bumrah', team: 'IND', role: 'Bowler', matchRate: 0.90 },
            { id: 'p4', name: 'Hardik Pandya', team: 'IND', role: 'All-Rounder', matchRate: 0.75 },
            { id: 'p5', name: 'KL Rahul', team: 'IND', role: 'Wicket-Keeper', matchRate: 0.70 },
            
            { id: 'p6', name: 'Babar Azam', team: 'PAK', role: 'Batsman', matchRate: 0.85 },
            { id: 'p7', name: 'Mohammad Rizwan', team: 'PAK', role: 'Wicket-Keeper', matchRate: 0.80 },
            { id: 'p8', name: 'Shaheen Afridi', team: 'PAK', role: 'Bowler', matchRate: 0.85 },
            { id: 'p9', name: 'Shadab Khan', team: 'PAK', role: 'All-Rounder', matchRate: 0.70 },
            
            { id: 'p10', name: 'Joe Root', team: 'ENG', role: 'Batsman', matchRate: 0.80 },
            { id: 'p11', name: 'Jos Buttler', team: 'ENG', role: 'Wicket-Keeper', matchRate: 0.75 },
            { id: 'p12', name: 'Jofra Archer', team: 'ENG', role: 'Bowler', matchRate: 0.80 },
            { id: 'p13', name: 'Ben Stokes', team: 'ENG', role: 'All-Rounder', matchRate: 0.85 },
            
            { id: 'p14', name: 'Steve Smith', team: 'AUS', role: 'Batsman', matchRate: 0.85 },
            { id: 'p15', name: 'David Warner', team: 'AUS', role: 'Batsman', matchRate: 0.80 },
            { id: 'p16', name: 'Pat Cummins', team: 'AUS', role: 'Bowler', matchRate: 0.85 },
            { id: 'p17', name: 'Glenn Maxwell', team: 'AUS', role: 'All-Rounder', matchRate: 0.75 },
            { id: 'p18', name: 'Alex Carey', team: 'AUS', role: 'Wicket-Keeper', matchRate: 0.70 },
        ];

        const MATCHES = [
            { id: 'm1', team1: 'IND', team2: 'PAK', date: '2026-02-15', venue: 'Dubai' },
            { id: 'm2', team1: 'ENG', team2: 'AUS', date: '2026-02-16', venue: 'Dubai' },
            { id: 'm3', team1: 'IND', team2: 'ENG', date: '2026-02-18', venue: 'Abu Dhabi' },
            { id: 'm4', team1: 'PAK', team2: 'AUS', date: '2026-02-19', venue: 'Sharjah' },
            { id: 'm5', team1: 'IND', team2: 'AUS', date: '2026-02-21', venue: 'Dubai' },
            { id: 'm6', team1: 'PAK', team2: 'ENG', date: '2026-02-22', venue: 'Dubai' }
        ];

        // Team composition rules (not displayed but used for validation)
        const TEAM_RULES = {
            minBatsmen: 3,
            maxBatsmen: 6,
            minBowlers: 3,
            maxBowlers: 6,
            minAllRounders: 1,
            maxAllRounders: 4,
            minWicketKeepers: 1,
            maxWicketKeepers: 2,
            totalPlayers: 11,
            maxFromOneTeam: 7
        };

        // ============================================
        // MAIN APP COMPONENT
        // ============================================
        function App() {
            // Auth & User State
            const [currentUser, setCurrentUser] = useState(null);
            const [isLogin, setIsLogin] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            // App State
            const [activeTab, setActiveTab] = useState('myTeam');
            const [selectedPlayers, setSelectedPlayers] = useState([]);
            const [captainSelections, setCaptainSelections] = useState({});
            const [contest, setContest] = useState(null);
            const [allUsers, setAllUsers] = useState({});
            const [contestCode, setContestCode] = useState('');
            const [contestName, setContestName] = useState('');
            const [joinContestCode, setJoinContestCode] = useState('');
            
            // Admin State
            const [updateMatchId, setUpdateMatchId] = useState(null);
            const [playerPoints, setPlayerPoints] = useState({});
            
            // Loading State
            const [loading, setLoading] = useState(true);

            // ============================================
            // FIREBASE LISTENERS
            // ============================================
            useEffect(() => {
                // Listen to contest changes
                const unsubscribeContest = db.collection('contests').doc('main').onSnapshot((doc) => {
                    if (doc.exists) {
                        setContest(doc.data());
                    }
                });

                // Listen to users changes
                const unsubscribeUsers = db.collection('users').onSnapshot((snapshot) => {
                    const usersData = {};
                    snapshot.forEach((doc) => {
                        usersData[doc.id] = doc.data();
                    });
                    setAllUsers(usersData);
                });

                setLoading(false);

                return () => {
                    unsubscribeContest();
                    unsubscribeUsers();
                };
            }, []);

            // Load current user from localStorage (session management)
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    setCurrentUser(JSON.parse(savedUser));
                }
            }, []);

            // ============================================
            // AUTH FUNCTIONS
            // ============================================
            const handleAuth = async () => {
                setError('');
                setSuccess('');
                
                if (isLogin) {
                    // Login
                    if (!username || !password) {
                        setError('Please enter username and password');
                        return;
                    }

                    try {
                        const userDoc = await db.collection('users').doc(username).get();
                        
                        if (!userDoc.exists) {
                            setError('User not found');
                            return;
                        }

                        const userData = userDoc.data();
                        if (userData.password !== password) {
                            setError('Incorrect password');
                            return;
                        }

                        const user = { id: username, ...userData };
                        setCurrentUser(user);
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        setSuccess('Login successful!');
                    } catch (err) {
                        setError('Login failed: ' + err.message);
                    }
                } else {
                    // Register
                    if (!username || !password || !name) {
                        setError('Please fill all fields');
                        return;
                    }

                    try {
                        const userDoc = await db.collection('users').doc(username).get();
                        
                        if (userDoc.exists) {
                            setError('Username already exists');
                            return;
                        }

                        const newUser = {
                            username,
                            password,
                            name,
                            isAdmin: username === 'admin',
                            createdAt: Date.now()
                        };

                        await db.collection('users').doc(username).set(newUser);
                        
                        const user = { id: username, ...newUser };
                        setCurrentUser(user);
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        setSuccess('Registration successful!');
                    } catch (err) {
                        setError('Registration failed: ' + err.message);
                    }
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                localStorage.removeItem('currentUser');
                setUsername('');
                setPassword('');
                setName('');
            };

            // ============================================
            // TEAM BUILDING FUNCTIONS
            // ============================================
            const togglePlayerSelection = (player) => {
                setError('');
                
                if (selectedPlayers.find(p => p.id === player.id)) {
                    setSelectedPlayers(selectedPlayers.filter(p => p.id !== player.id));
                } else {
                    if (selectedPlayers.length >= TEAM_RULES.totalPlayers) {
                        setError(`You can only select ${TEAM_RULES.totalPlayers} players`);
                        return;
                    }
                    setSelectedPlayers([...selectedPlayers, player]);
                }
            };

            const validateTeam = () => {
                const batsmen = selectedPlayers.filter(p => p.role === 'Batsman').length;
                const bowlers = selectedPlayers.filter(p => p.role === 'Bowler').length;
                const allRounders = selectedPlayers.filter(p => p.role === 'All-Rounder').length;
                const wicketKeepers = selectedPlayers.filter(p => p.role === 'Wicket-Keeper').length;
                
                const teamCounts = {};
                selectedPlayers.forEach(p => {
                    teamCounts[p.team] = (teamCounts[p.team] || 0) + 1;
                });
                
                const errors = [];
                
                if (selectedPlayers.length !== TEAM_RULES.totalPlayers) {
                    errors.push(`Select exactly ${TEAM_RULES.totalPlayers} players`);
                }
                if (batsmen < TEAM_RULES.minBatsmen) {
                    errors.push(`Need at least ${TEAM_RULES.minBatsmen} batsmen`);
                }
                if (batsmen > TEAM_RULES.maxBatsmen) {
                    errors.push(`Maximum ${TEAM_RULES.maxBatsmen} batsmen allowed`);
                }
                if (bowlers < TEAM_RULES.minBowlers) {
                    errors.push(`Need at least ${TEAM_RULES.minBowlers} bowlers`);
                }
                if (bowlers > TEAM_RULES.maxBowlers) {
                    errors.push(`Maximum ${TEAM_RULES.maxBowlers} bowlers allowed`);
                }
                if (allRounders < TEAM_RULES.minAllRounders) {
                    errors.push(`Need at least ${TEAM_RULES.minAllRounders} all-rounder`);
                }
                if (allRounders > TEAM_RULES.maxAllRounders) {
                    errors.push(`Maximum ${TEAM_RULES.maxAllRounders} all-rounders allowed`);
                }
                if (wicketKeepers < TEAM_RULES.minWicketKeepers) {
                    errors.push(`Need at least ${TEAM_RULES.minWicketKeepers} wicket-keeper`);
                }
                if (wicketKeepers > TEAM_RULES.maxWicketKeepers) {
                    errors.push(`Maximum ${TEAM_RULES.maxWicketKeepers} wicket-keepers allowed`);
                }
                
                Object.entries(teamCounts).forEach(([team, count]) => {
                    if (count > TEAM_RULES.maxFromOneTeam) {
                        errors.push(`Maximum ${TEAM_RULES.maxFromOneTeam} players from ${team}`);
                    }
                });
                
                return errors;
            };

            const saveTeam = async () => {
                setError('');
                setSuccess('');
                
                const errors = validateTeam();
                if (errors.length > 0) {
                    setError(errors.join(', '));
                    return;
                }

                try {
                    const contestDoc = await db.collection('contests').doc('main').get();
                    if (!contestDoc.exists) {
                        setError('No contest available');
                        return;
                    }

                    const contestData = contestDoc.data();
                    const updatedParticipants = {
                        ...contestData.participants,
                        [currentUser.id]: {
                            name: currentUser.name,
                            team: selectedPlayers.map(p => p.id),
                            captainSelections: captainSelections,
                            totalPoints: contestData.participants[currentUser.id]?.totalPoints || 0
                        }
                    };

                    await db.collection('contests').doc('main').update({
                        participants: updatedParticipants
                    });

                    setSuccess('Team saved successfully!');
                } catch (err) {
                    setError('Failed to save team: ' + err.message);
                }
            };

            // ============================================
            // CAPTAIN SELECTION FUNCTIONS
            // ============================================
            const setCaptain = (matchId, playerId) => {
                const newSelections = { ...captainSelections };
                if (!newSelections[matchId]) {
                    newSelections[matchId] = {};
                }
                newSelections[matchId].captain = playerId;
                setCaptainSelections(newSelections);
            };

            const setViceCaptain = (matchId, playerId) => {
                const newSelections = { ...captainSelections };
                if (!newSelections[matchId]) {
                    newSelections[matchId] = {};
                }
                newSelections[matchId].viceCaptain = playerId;
                setCaptainSelections(newSelections);
            };

            const getMatchPlayers = (match) => {
                return selectedPlayers.filter(p => p.team === match.team1 || p.team === match.team2);
            };

            // ============================================
            // CONTEST FUNCTIONS
            // ============================================
            const createContest = async () => {
                setError('');
                setSuccess('');
                
                if (!contestCode || !contestName) {
                    setError('Please enter contest code and name');
                    return;
                }

                try {
                    const newContest = {
                        code: contestCode,
                        name: contestName,
                        createdBy: currentUser.id,
                        createdAt: Date.now(),
                        participants: {},
                        matches: MATCHES.map(m => ({ ...m, pointsUpdated: false }))
                    };

                    await db.collection('contests').doc('main').set(newContest);
                    setSuccess('Contest created successfully!');
                    setContestCode('');
                    setContestName('');
                } catch (err) {
                    setError('Failed to create contest: ' + err.message);
                }
            };

            const joinContest = async () => {
                setError('');
                setSuccess('');
                
                if (!joinContestCode) {
                    setError('Please enter contest code');
                    return;
                }

                if (!contest) {
                    setError('No contest available');
                    return;
                }

                if (contest.code !== joinContestCode) {
                    setError('Invalid contest code');
                    return;
                }

                try {
                    const updatedParticipants = {
                        ...contest.participants,
                        [currentUser.id]: {
                            name: currentUser.name,
                            team: [],
                            captainSelections: {},
                            totalPoints: 0
                        }
                    };

                    await db.collection('contests').doc('main').update({
                        participants: updatedParticipants
                    });

                    setSuccess('Joined contest successfully!');
                    setJoinContestCode('');
                } catch (err) {
                    setError('Failed to join contest: ' + err.message);
                }
            };

            // ============================================
            // ADMIN FUNCTIONS
            // ============================================
            const updatePlayerPointsValue = (playerId, value) => {
                const key = `${updateMatchId}-${playerId}`;
                setPlayerPoints({
                    ...playerPoints,
                    [key]: parseInt(value) || 0
                });
            };

            const calculateAndUpdateLeaderboard = async () => {
                setError('');
                setSuccess('');
                
                if (!updateMatchId) {
                    setError('Please select a match');
                    return;
                }

                try {
                    const updatedParticipants = { ...contest.participants };
                    
                    Object.entries(updatedParticipants).forEach(([userId, participant]) => {
                        let matchPoints = 0;
                        const captainId = participant.captainSelections[updateMatchId]?.captain;
                        const viceCaptainId = participant.captainSelections[updateMatchId]?.viceCaptain;
                        
                        participant.team.forEach(playerId => {
                            const key = `${updateMatchId}-${playerId}`;
                            const points = playerPoints[key] || 0;
                            
                            if (playerId === captainId) {
                                matchPoints += points * 2;
                            } else if (playerId === viceCaptainId) {
                                matchPoints += points * 1.5;
                            } else {
                                matchPoints += points;
                            }
                        });
                        
                        updatedParticipants[userId].totalPoints = 
                            (updatedParticipants[userId].totalPoints || 0) + matchPoints;
                    });

                    const updatedMatches = contest.matches.map(m => 
                        m.id === updateMatchId ? { ...m, pointsUpdated: true } : m
                    );

                    await db.collection('contests').doc('main').update({
                        participants: updatedParticipants,
                        matches: updatedMatches
                    });

                    setSuccess('Leaderboard updated successfully!');
                    setUpdateMatchId(null);
                    setPlayerPoints({});
                } catch (err) {
                    setError('Failed to update leaderboard: ' + err.message);
                }
            };

            // ============================================
            // HELPER FUNCTIONS
            // ============================================
            const getAvailablePlayers = () => {
                if (!updateMatchId) return [];
                const match = MATCHES.find(m => m.id === updateMatchId);
                if (!match) return [];
                return PLAYERS.filter(p => p.team === match.team1 || p.team === match.team2);
            };

            const getLeaderboard = () => {
                if (!contest) return [];
                return Object.entries(contest.participants)
                    .map(([userId, data]) => ({
                        userId,
                        name: data.name,
                        totalPoints: data.totalPoints || 0
                    }))
                    .sort((a, b) => b.totalPoints - a.totalPoints);
            };

            const getAllUsers = () => {
                return Object.entries(allUsers).map(([id, data]) => ({
                    id,
                    ...data
                }));
            };

            const getTeamCounts = () => {
                const batsmen = selectedPlayers.filter(p => p.role === 'Batsman').length;
                const bowlers = selectedPlayers.filter(p => p.role === 'Bowler').length;
                const allRounders = selectedPlayers.filter(p => p.role === 'All-Rounder').length;
                const wicketKeepers = selectedPlayers.filter(p => p.role === 'Wicket-Keeper').length;
                
                return { batsmen, bowlers, allRounders, wicketKeepers };
            };

            // Load user's team when contest loads
            useEffect(() => {
                if (contest && currentUser && contest.participants[currentUser.id]) {
                    const userTeam = contest.participants[currentUser.id];
                    const teamPlayers = PLAYERS.filter(p => userTeam.team.includes(p.id));
                    setSelectedPlayers(teamPlayers);
                    setCaptainSelections(userTeam.captainSelections || {});
                }
            }, [contest, currentUser]);

            // ============================================
            // RENDER
            // ============================================
            if (loading) {
                return <div style={{textAlign: 'center', padding: '50px'}}>Loading...</div>;
            }

            if (!currentUser) {
                return (
                    <div>
                        <div className="header">
                            <h1>üèè T20 FANTASY</h1>
                            <p>Build Your Dream Team & Compete</p>
                        </div>
                        
                        <div className="card" style={{maxWidth: '500px', margin: '0 auto'}}>
                            <h2>{isLogin ? 'Login' : 'Register'}</h2>
                            
                            {error && <div className="error-box">{error}</div>}
                            {success && <div className="success-box">{success}</div>}
                            
                            <div className="input-group">
                                <label>Username</label>
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Enter username" />
                            </div>
                            
                            <div className="input-group">
                                <label>Password</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Enter password" />
                            </div>
                            
                            {!isLogin && (
                                <div className="input-group">
                                    <label>Full Name</label>
                                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Enter your name" />
                                </div>
                            )}
                            
                            <button className="btn" onClick={handleAuth} style={{width: '100%'}}>
                                {isLogin ? 'Login' : 'Register'}
                            </button>
                            
                            <p style={{textAlign: 'center', marginTop: '20px', color: '#94a3b8'}}>
                                {isLogin ? "Don't have an account? " : "Already have an account? "}
                                <span style={{color: '#10b981', cursor: 'pointer', fontWeight: '600'}} onClick={() => {
                                    setIsLogin(!isLogin);
                                    setError('');
                                    setSuccess('');
                                }}>
                                    {isLogin ? 'Register' : 'Login'}
                                </span>
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="header">
                        <h1>üèè T20 FANTASY</h1>
                        <p>Build Your Dream Team & Compete</p>
                        <div className="user-badge">
                            <span>{currentUser.name}</span>
                            {currentUser.isAdmin && <span className="admin-badge">ADMIN</span>}
                        </div>
                    </div>

                    <div className="tabs">
                        <button className={`tab ${activeTab === 'myTeam' ? 'active' : ''}`} onClick={() => setActiveTab('myTeam')}>
                            My Team
                        </button>
                        <button className={`tab ${activeTab === 'matches' ? 'active' : ''}`} onClick={() => setActiveTab('matches')}>
                            Matches
                        </button>
                        <button className={`tab ${activeTab === 'contest' ? 'active' : ''}`} onClick={() => setActiveTab('contest')}>
                            Contest
                        </button>
                        <button className={`tab ${activeTab === 'leaderboard' ? 'active' : ''}`} onClick={() => setActiveTab('leaderboard')}>
                            Leaderboard
                        </button>
                        {currentUser.isAdmin && (
                            <>
                                <button className={`tab ${activeTab === 'adminPanel' ? 'active' : ''}`} onClick={() => setActiveTab('adminPanel')}>
                                    Admin Panel
                                </button>
                                <button className={`tab ${activeTab === 'users' ? 'active' : ''}`} onClick={() => setActiveTab('users')}>
                                    Users
                                </button>
                            </>
                        )}
                    </div>

                    {error && <div className="error-box">{error}</div>}
                    {success && <div className="success-box">{success}</div>}

                    {/* MY TEAM TAB */}
                    {activeTab === 'myTeam' && (
                        <div>
                            <div className="team-summary">
                                <h3>Team Summary</h3>
                                <div className="team-counts">
                                    <div className="count-item">
                                        <div className="label">Selected</div>
                                        <div className="value">{selectedPlayers.length}/{TEAM_RULES.totalPlayers}</div>
                                    </div>
                                    <div className="count-item">
                                        <div className="label">Batsmen</div>
                                        <div className="value">{getTeamCounts().batsmen}</div>
                                    </div>
                                    <div className="count-item">
                                        <div className="label">Bowlers</div>
                                        <div className="value">{getTeamCounts().bowlers}</div>
                                    </div>
                                    <div className="count-item">
                                        <div className="label">All-Rounders</div>
                                        <div className="value">{getTeamCounts().allRounders}</div>
                                    </div>
                                    <div className="count-item">
                                        <div className="label">Wicket-Keepers</div>
                                        <div className="value">{getTeamCounts().wicketKeepers}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="card">
                                <h2>Select Your Players</h2>
                                <div className="player-grid">
                                    {PLAYERS.map(player => (
                                        <div 
                                            key={player.id} 
                                            className={`player-card ${selectedPlayers.find(p => p.id === player.id) ? 'selected' : ''}`}
                                            onClick={() => togglePlayerSelection(player)}
                                        >
                                            <span className="team-badge">{player.team}</span>
                                            <h3>{player.name}</h3>
                                            <span className="role-badge">{player.role}</span>
                                            <div className="stats">
                                                <span>Match Rate</span>
                                                <span>{(player.matchRate * 100).toFixed(0)}%</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <button className="btn" onClick={saveTeam} style={{marginTop: '25px', width: '100%'}}>
                                    Save Team
                                </button>
                            </div>
                        </div>
                    )}

                    {/* MATCHES TAB */}
                    {activeTab === 'matches' && (
                        <div className="card">
                            <h2>Select Captain & Vice-Captain</h2>
                            {MATCHES.map(match => {
                                const matchPlayers = getMatchPlayers(match);
                                return (
                                    <div key={match.id} className="match-card">
                                        <div className="match-header">
                                            <h3>{match.team1} vs {match.team2}</h3>
                                            <span className="match-date">{match.date}</span>
                                        </div>
                                        <p style={{color: '#94a3b8', marginBottom: '15px'}}>{match.venue}</p>
                                        
                                        {matchPlayers.length === 0 ? (
                                            <p style={{color: '#94a3b8'}}>No players selected from these teams</p>
                                        ) : (
                                            <div className="captain-selection">
                                                <div>
                                                    <label style={{display: 'block', marginBottom: '10px', color: '#cbd5e1', fontWeight: '600'}}>
                                                        <span className="captain-label">C</span> Captain (2x)
                                                    </label>
                                                    <select 
                                                        value={captainSelections[match.id]?.captain || ''} 
                                                        onChange={(e) => setCaptain(match.id, e.target.value)}
                                                        style={{width: '100%', padding: '12px', background: '#1a1f3a', border: '2px solid #2d3548', borderRadius: '10px', color: 'white'}}
                                                    >
                                                        <option value="">Select Captain</option>
                                                        {matchPlayers.map(p => (
                                                            <option key={p.id} value={p.id}>{p.name}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                
                                                <div>
                                                    <label style={{display: 'block', marginBottom: '10px', color: '#cbd5e1', fontWeight: '600'}}>
                                                        <span className="vice-captain-label">VC</span> Vice-Captain (1.5x)
                                                    </label>
                                                    <select 
                                                        value={captainSelections[match.id]?.viceCaptain || ''} 
                                                        onChange={(e) => setViceCaptain(match.id, e.target.value)}
                                                        style={{width: '100%', padding: '12px', background: '#1a1f3a', border: '2px solid #2d3548', borderRadius: '10px', color: 'white'}}
                                                    >
                                                        <option value="">Select Vice-Captain</option>
                                                        {matchPlayers.map(p => (
                                                            <option key={p.id} value={p.id}>{p.name}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            <button className="btn" onClick={saveTeam} style={{marginTop: '20px', width: '100%'}}>
                                Save Captain Selections
                            </button>
                        </div>
                    )}

                    {/* CONTEST TAB */}
                    {activeTab === 'contest' && (
                        <div>
                            {!contest ? (
                                currentUser.isAdmin ? (
                                    <div className="card">
                                        <h2>Create Contest</h2>
                                        <div className="input-group">
                                            <label>Contest Code</label>
                                            <input type="text" value={contestCode} onChange={(e) => setContestCode(e.target.value)} placeholder="e.g., WC2026" />
                                        </div>
                                        <div className="input-group">
                                            <label>Contest Name</label>
                                            <input type="text" value={contestName} onChange={(e) => setContestName(e.target.value)} placeholder="e.g., World Cup 2026 Contest" />
                                        </div>
                                        <button className="btn" onClick={createContest}>Create Contest</button>
                                    </div>
                                ) : (
                                    <div className="card">
                                        <h2>No Contest Available</h2>
                                        <p style={{color: '#94a3b8'}}>Please wait for the admin to create a contest.</p>
                                    </div>
                                )
                            ) : (
                                <div>
                                    <div className="card">
                                        <h2>{contest.name}</h2>
                                        <div className="contest-code">
                                            <p style={{fontSize: '14px', marginBottom: '8px', color: '#94a3b8'}}>Contest Code</p>
                                            <div className="contest-code-value">{contest.code}</div>
                                            <p style={{fontSize: '13px', marginTop: '8px', color: '#94a3b8'}}>Share this code with participants</p>
                                        </div>
                                        <div style={{marginTop: '15px', padding: '12px', background: '#0a0e27', borderRadius: '10px'}}>
                                            <p style={{color: '#cbd5e1'}}>üë• Participants: <strong>{Object.keys(contest.participants).length}</strong></p>
                                            <p style={{color: '#cbd5e1', marginTop: '6px'}}>üèè Matches: <strong>{contest.matches.length}</strong></p>
                                        </div>
                                    </div>

                                    {!contest.participants[currentUser.id] && !currentUser.isAdmin && (
                                        <div className="card">
                                            <h2>Join Contest</h2>
                                            <div className="input-group">
                                                <label>Enter Contest Code</label>
                                                <input type="text" value={joinContestCode} onChange={(e) => setJoinContestCode(e.target.value)} placeholder="Enter code" />
                                            </div>
                                            <button className="btn btn-secondary" onClick={joinContest}>Join Contest</button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* LEADERBOARD TAB */}
                    {activeTab === 'leaderboard' && (
                        <div className="card">
                            <h2>Contest Leaderboard</h2>
                            {!contest ? (
                                <p style={{color: '#94a3b8'}}>No contest found.</p>
                            ) : (
                                <table className="leaderboard-table">
                                    <thead>
                                        <tr><th>Rank</th><th>Player</th><th>Points</th></tr>
                                    </thead>
                                    <tbody>
                                        {getLeaderboard().map((p, i) => (
                                            <tr key={p.userId}>
                                                <td><span className={`rank-badge ${i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : ''}`}>{i + 1}</span></td>
                                                <td style={{fontWeight: p.userId === currentUser.id ? '700' : '400'}}>{p.name} {p.userId === currentUser.id ? '(You)' : ''}</td>
                                                <td><strong style={{fontSize: '1.1rem', color: '#10b981'}}>{p.totalPoints}</strong></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    )}

                    {/* ADMIN PANEL TAB (Admin only) */}
                    {activeTab === 'adminPanel' && currentUser.isAdmin && (
                        <div className="card">
                            <h2>Admin Panel - Update Match Points</h2>
                            
                            <div className="info-box" style={{marginBottom: '20px'}}>
                                <h3>üìä Instructions</h3>
                                <p>1. Select completed match</p>
                                <p>2. Enter points for each player</p>
                                <p>3. Click "Calculate & Update Leaderboard"</p>
                                <p>4. All participants' points will update automatically with C/VC multipliers</p>
                            </div>

                            <div className="input-group">
                                <label>Select Match</label>
                                <select onChange={(e) => setUpdateMatchId(e.target.value)} value={updateMatchId || ''}>
                                    <option value="">Choose match...</option>
                                    {MATCHES.map(m => (
                                        <option key={m.id} value={m.id}>{m.team1} vs {m.team2} - {m.date}</option>
                                    ))}
                                </select>
                            </div>

                            {updateMatchId && (
                                <>
                                    <div className="points-grid">
                                        {getAvailablePlayers().map(player => (
                                            <div key={player.id} className="points-input-item">
                                                <label>{player.name}</label>
                                                <input type="number" value={playerPoints[`${updateMatchId}-${player.id}`] || 0} onChange={(e) => updatePlayerPointsValue(player.id, e.target.value)} placeholder="0" />
                                            </div>
                                        ))}
                                    </div>
                                    <button className="btn" onClick={calculateAndUpdateLeaderboard} style={{marginTop: '20px', width: '100%'}}>
                                        Calculate & Update Leaderboard
                                    </button>
                                </>
                            )}
                        </div>
                    )}

                    {/* USERS TAB (Admin only) */}
                    {activeTab === 'users' && currentUser.isAdmin && (
                        <div className="card">
                            <h2>Registered Users</h2>
                            <div className="info-box">
                                <h3>üë• User Management</h3>
                                <p>View all users who have registered for the fantasy contest.</p>
                            </div>
                            
                            {getAllUsers().length === 0 ? (
                                <p style={{color: '#94a3b8', marginTop: '20px'}}>No users registered yet.</p>
                            ) : (
                                <table className="users-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Username</th>
                                            <th>User ID</th>
                                            <th>Joined</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {getAllUsers().map((user, index) => (
                                            <tr key={user.id}>
                                                <td>{index + 1}</td>
                                                <td style={{fontWeight: '600'}}>{user.name}</td>
                                                <td>{user.username}</td>
                                                <td style={{fontSize: '13px', color: '#94a3b8'}}>{user.id}</td>
                                                <td>{new Date(user.createdAt).toLocaleDateString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                            
                            <div style={{marginTop: '20px', padding: '15px', background: '#0a0e27', borderRadius: '10px'}}>
                                <p style={{color: '#cbd5e1', fontSize: '14px'}}>
                                    <strong>Total Registered Users:</strong> {getAllUsers().length}
                                </p>
                            </div>
                        </div>
                    )}

                    <div style={{textAlign: 'center', marginTop: '25px'}}>
                        <button className="btn btn-danger btn-small" onClick={handleLogout}>Logout</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
