<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T20 World Cup 2026 Fantasy League</title>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase v9 (Modular SDK) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, orderBy, onSnapshot, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDacks7Qnk42D2898leU_kgG8DZsYTFxCw",
            authDomain: "t20-fantasy-contest.firebaseapp.com",
            projectId: "t20-fantasy-contest",
            storageBucket: "t20-fantasy-contest.firebasestorage.app",
            messagingSenderId: "180217303236",
            appId: "1:180217303236:web:a6b078a7a7d0fa070c3991",
            measurementId: "G-LYY944KN99"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make globally available
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            collection, query, where, getDocs, doc, setDoc, getDoc, addDoc, 
            updateDoc, deleteDoc, orderBy, onSnapshot, writeBatch,
            signInWithEmailAndPassword, createUserWithEmailAndPassword,
            signOut, onAuthStateChanged
        };
        window.firebaseReady = true;
        
        console.log("‚úÖ Firebase initialized successfully!");
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Exo 2', sans-serif;
            background: #0a0e1a;
            color: #e0e6ed;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                linear-gradient(180deg, #0a0e1a 0%, #0f1729 100%);
            pointer-events: none;
            z-index: 0;
        }
        
        #root {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            padding: 40px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            letter-spacing: 3px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            position: relative;
            z-index: 1;
        }

        .user-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: rgba(31, 41, 55, 0.5);
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 18px;
            background: transparent;
            border: 2px solid transparent;
            color: #9ca3af;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            text-align: center;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        /* Card Styles */
        .card {
            background: rgba(31, 41, 55, 0.6);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .card h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            margin-bottom: 25px;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Match Card Styles */
        .match-list {
            display: grid;
            gap: 20px;
        }

        .match-card {
            background: rgba(17, 24, 39, 0.8);
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .match-card:hover {
            border-color: #10b981;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .teams {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            color: #10b981;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-upcoming {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .status-live {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .match-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 0.85rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e0e6ed;
        }

        /* Player List Styles */
        .players-section {
            margin-top: 30px;
        }

        .team-section {
            margin-bottom: 30px;
        }

        .team-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .player-card {
            background: rgba(17, 24, 39, 0.6);
            border: 2px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
        }

        .player-card:hover {
            border-color: #10b981;
            transform: translateY(-3px);
        }

        .player-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 8px;
        }

        .player-role {
            display: inline-block;
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .player-stats {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .stat-value {
            font-weight: 700;
            color: #e0e6ed;
        }

        /* Button Styles */
        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-family: 'Orbitron', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .leaderboard-table thead {
            background: rgba(16, 185, 129, 0.2);
        }

        .leaderboard-table th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
            color: #10b981;
        }

        .leaderboard-table td {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-table tr:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .rank {
            font-size: 1.5rem;
            font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            color: #10b981;
        }

        .rank-1 { color: #fbbf24; }
        .rank-2 { color: #d1d5db; }
        .rank-3 { color: #f97316; }

        .points-highlight {
            font-size: 1.3rem;
            font-weight: 900;
            color: #10b981;
            font-family: 'Orbitron', sans-serif;
        }

        /* Auth Styles */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: rgba(31, 41, 55, 0.8);
            padding: 50px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 450px;
            width: 100%;
        }

        .auth-card h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #9ca3af;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            background: rgba(17, 24, 39, 0.8);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #9ca3af;
        }

        .auth-toggle a {
            color: #10b981;
            text-decoration: none;
            font-weight: 700;
            cursor: pointer;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #10b981;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            padding: 15px;
            border-radius: 12px;
            color: #fecaca;
            margin-bottom: 20px;
        }

        /* Admin Styles */
        .admin-section {
            margin-top: 30px;
        }

        .admin-section h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #10b981;
        }

        .player-score-input {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: rgba(17, 24, 39, 0.6);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .player-score-input input {
            padding: 10px;
            background: rgba(31, 41, 55, 0.8);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
        }

        .player-score-input input:focus {
            outline: none;
            border-color: #10b981;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .user-badge, .logout-btn {
                position: relative;
                top: auto;
                left: auto;
                right: auto;
                margin-top: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
            }

            .players-grid {
                grid-template-columns: 1fr;
            }

            .player-score-input {
                grid-template-columns: 1fr;
            }

            .leaderboard-table {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            

            useEffect(() => {
                const checkAuth = () => {
                    if (!window.firebaseReady) {
                        setTimeout(checkAuth, 100);
                        return;
                    }

                    const { onAuthStateChanged } = window.firebaseModules;
                    onAuthStateChanged(window.firebaseAuth, (currentUser) => {
                        if (currentUser) {
                            checkUserRole(currentUser);
                        } else {
                            setUser(null);
                            setLoading(false);
                        }
                    });
                };
                checkAuth();
            }, []);

            const checkUserRole = async (currentUser) => {
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', currentUser.uid));
                    
                    if (userDoc.exists()) {
                        setUser({
                            uid: currentUser.uid,
                            email: currentUser.email,
                            ...userDoc.data()
                        });
                    } else {
                        const newUser = {
                            email: currentUser.email,
                            username: currentUser.email.split('@')[0],
                            role: 'user',
                            createdAt: new Date().toISOString()
                        };
                        const { setDoc } = window.firebaseModules;
                        await setDoc(doc(window.firebaseDb, 'users', currentUser.uid), newUser);
                        setUser({ uid: currentUser.uid, ...newUser });
                    }
                } catch (error) {
                    console.error('Error checking user role:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                const username = e.target.username.value.trim();
                const password = e.target.password.value;

                if (!username || !password) {
                    alert('Please enter both username and password');
                    return;
                }

                try {
                    const { collection, query, where, getDocs, signInWithEmailAndPassword } = window.firebaseModules;
                    
                    // Find user by username
                    const usersRef = collection(window.firebaseDb, 'users');
                    const q = query(usersRef, where('username', '==', username));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        alert('Invalid username or password. Contact admin for login credentials.');
                        return;
                    }
                    
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    // Sign in with email (stored in user document)
                    await signInWithEmailAndPassword(window.firebaseAuth, userData.email, password);
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Invalid username or password. Contact admin for login credentials.');
                }
            };

            const handleLogout = async () => {
                const { signOut } = window.firebaseModules;
                await signOut(window.firebaseAuth);
            };

            if (loading) {
                return <div className="loading">Loading...</div>;
            }

            if (!user) {
                return (
                    <div className="auth-container">
                        <div className="auth-card">
                            <h2>LOGIN</h2>
                            <form onSubmit={handleAuth}>
                                <div className="form-group">
                                    <label>Username</label>
                                    <input type="text" name="username" required autoComplete="username" />
                                </div>
                                <div className="form-group">
                                    <label>Password</label>
                                    <input type="password" name="password" required />
                                </div>
                                <button type="submit" className="btn" style={{ width: '100%' }}>
                                    Login
                                </button>
                            </form>
                            <div className="auth-toggle">
                                Don't have credentials? Contact admin for access.
                            </div>
                        </div>
                    </div>
                );
            }

            return <Dashboard user={user} onLogout={handleLogout} />;
        }

        function Dashboard({ user, onLogout }) {
            const [activeTab, setActiveTab] = useState('matches');

            return (
                <>
                    <div className="header">
                        <div className="user-badge">
                            üë§ {user.username || user.email}
                            {user.role === 'admin' && <span className="admin-badge">Admin</span>}
                        </div>
                        <h1>‚ö° T20 WORLD CUP 2026</h1>
                        <button className="logout-btn" onClick={onLogout}>Logout</button>
                    </div>

                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'matches' ? 'active' : ''}`}
                            onClick={() => setActiveTab('matches')}
                        >
                            üèè Matches
                        </button>
                        <button 
                            className={`tab ${activeTab === 'leaderboard' ? 'active' : ''}`}
                            onClick={() => setActiveTab('leaderboard')}
                        >
                            üèÜ Leaderboard
                        </button>
                        {user.role === 'admin' && (
                            <button 
                                className={`tab ${activeTab === 'admin' ? 'active' : ''}`}
                                onClick={() => setActiveTab('admin')}
                            >
                                ‚öôÔ∏è Admin
                            </button>
                        )}
                    </div>

                    {activeTab === 'matches' && <MatchesTab user={user} />}
                    {activeTab === 'leaderboard' && <LeaderboardTab />}
                    {activeTab === 'admin' && user.role === 'admin' && <AdminTab />}
                </>
            );
        }

        function MatchesTab({ user }) {
            const [matches, setMatches] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [players, setPlayers] = useState({ team1: [], team2: [] });
            const [loading, setLoading] = useState(true);
            const [hasJoined, setHasJoined] = useState(false);

            // Team name mapping
            const teamNameMap = {
                'Ind': 'India', 'Pak': 'Pakistan', 'Aus': 'Australia', 'Eng': 'England',
                'NZ': 'New Zealand', 'SA': 'South Africa', 'WI': 'West Indies',
                'SL': 'Sri Lanka', 'Ban': 'Bangladesh', 'Afg': 'Afghanistan',
                'Ire': 'Ireland', 'Sco': 'Scotland', 'Zim': 'Zimbabwe',
                'USA': 'USA', 'Can': 'Canada', 'Ned': 'Netherlands',
                'Nam': 'Namibia', 'PNG': 'Papua New Guinea', 'Oma': 'Oman',
                'UAE': 'UAE', 'Nep': 'Nepal'
            };

            // Parse team names from match ID (e.g., "Ind vs Pak" -> ["India", "Pakistan"])
            const parseTeamNames = (matchId) => {
                const parts = matchId.split(' vs ');
                if (parts.length !== 2) return [matchId, ''];
                return parts.map(abbr => teamNameMap[abbr.trim()] || abbr.trim());
            };


            useEffect(() => {
                loadMatches();
            }, []);

            useEffect(() => {
                if (selectedMatch) {
                    loadPlayers();
                    checkIfJoined();
                }
            }, [selectedMatch]);

            const loadMatches = async () => {
                try {
                    const { collection, getDocs } = window.firebaseModules;
                    const matchesRef = collection(window.firebaseDb, 'matches');
                    const snapshot = await getDocs(matchesRef);
                    
                    const matchesList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // Sort by match# if available
                    matchesList.sort((a, b) => {
                        const matchNumA = parseInt(a['match#']) || 0;
                        const matchNumB = parseInt(b['match#']) || 0;
                        return matchNumA - matchNumB;
                    });
                    
                    console.log(`Loaded ${matchesList.length} matches from database`);
                    setMatches(matchesList);
                } catch (error) {
                    console.error('Error loading matches:', error);
                    alert('Error loading matches. Please refresh the page.');
                } finally {
                    setLoading(false);
                }
            };


            const loadPlayers = async () => {
                if (!selectedMatch) {
                    setPlayers({ team1: [], team2: [] });
                    return;
                }

                try {
                    const { collection, getDocs } = window.firebaseModules;
                    
                    // Parse team names from match ID
                    const [team1Name, team2Name] = parseTeamNames(selectedMatch.id);
                    
                    if (!team1Name || !team2Name) {
                        setPlayers({ team1: [], team2: [] });
                        return;
                    }
                    
                    // Fetch players from teams/{teamName}/playerName collection
                    const team1PlayersRef = collection(window.firebaseDb, 'teams', team1Name, 'playerName');
                    const team2PlayersRef = collection(window.firebaseDb, 'teams', team2Name, 'playerName');
                    
                    const [team1Snapshot, team2Snapshot] = await Promise.all([
                        getDocs(team1PlayersRef),
                        getDocs(team2PlayersRef)
                    ]);
                    
                    const team1Players = team1Snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        name: doc.id,
                        team: team1Name,
                        ...doc.data() 
                    }));
                    
                    const team2Players = team2Snapshot.docs.map(doc => ({ 
                        id: doc.id,
                        name: doc.id,
                        team: team2Name,
                        ...doc.data() 
                    }));
                    
                    setPlayers({ team1: team1Players, team2: team2Players });
                } catch (error) {
                    console.error('Error loading players:', error);
                    setPlayers({ team1: [], team2: [] });
                }
            };

            const checkIfJoined = async () => {
                if (!selectedMatch || !user) return;

                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const participationRef = doc(
                        window.firebaseDb, 
                        'matchParticipation', 
                        `${selectedMatch.id}_${user.uid}`
                    );
                    const participationDoc = await getDoc(participationRef);
                    setHasJoined(participationDoc.exists());
                } catch (error) {
                    console.error('Error checking participation:', error);
                }
            };

            const joinMatch = async () => {
                if (!selectedMatch || !user) return;

                try {
                    const { doc, setDoc, getDoc, updateDoc } = window.firebaseModules;
                    
                    // Create participation record
                    const participationRef = doc(
                        window.firebaseDb, 
                        'matchParticipation', 
                        `${selectedMatch.id}_${user.uid}`
                    );
                    
                    await setDoc(participationRef, {
                        matchId: selectedMatch.id,
                        userId: user.uid,
                        userEmail: user.email,
                        joinedAt: new Date().toISOString(),
                        points: 0
                    });

                    // Initialize or update leaderboard entry
                    const leaderboardRef = doc(window.firebaseDb, 'leaderboard', user.uid);
                    const leaderboardDoc = await getDoc(leaderboardRef);

                    if (leaderboardDoc.exists()) {
                        await updateDoc(leaderboardRef, {
                            matchesJoined: (leaderboardDoc.data().matchesJoined || 0) + 1,
                            updatedAt: new Date().toISOString()
                        });
                    } else {
                        await setDoc(leaderboardRef, {
                            userId: user.uid,
                            userEmail: user.email,
                            totalPoints: 0,
                            matchesJoined: 1,
                            matchesPlayed: 0,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }

                    alert('Successfully joined the match!');
                    setHasJoined(true);
                } catch (error) {
                    console.error('Error joining match:', error);
                    alert('Failed to join match');
                }
            };

            if (loading) {
                return <div className="card"><div className="loading">Loading matches...</div></div>;
            }

            if (selectedMatch) {
                return (
                    <div className="card">
                        <button 
                            onClick={() => setSelectedMatch(null)} 
                            className="btn btn-secondary" 
                            style={{ marginBottom: '20px' }}
                        >
                            ‚Üê Back to Matches
                        </button>

                        <div className="match-header">
                            <div className="teams">{selectedMatch.id}</div>
                            <span className={`status-badge status-${selectedMatch.status || 'upcoming'}`}>
                                {(selectedMatch.status || 'upcoming').toUpperCase()}
                            </span>
                        </div>

                        <div className="match-info">
                            <div className="info-item">
                                <span className="info-label">Match #</span>
                                <span className="info-value">{selectedMatch['match#'] || 'TBD'}</span>
                            </div>
                            <div className="info-item">
                                <span className="info-label">Date & Time</span>
                                <span className="info-value">
                                    {selectedMatch.matchtime ? new Date(selectedMatch.matchtime.seconds * 1000).toLocaleString() : 'TBD'}
                                </span>
                            </div>
                        </div>

                        {selectedMatch.status !== 'completed' && (
                            <button 
                                className="btn" 
                                style={{ marginTop: '20px', width: '100%' }}
                                onClick={joinMatch}
                                disabled={hasJoined}
                            >
                                {hasJoined ? '‚úì Joined' : 'Join This Match'}
                            </button>
                        )}

                        <div className="players-section">
                            <div className="team-section">
                                <div className="team-header">
                                    {parseTeamNames(selectedMatch.id)[0]} - Squad ({players.team1.length} players)
                                </div>
                                <div className="players-grid">
                                    {players.team1.map(player => (
                                        <div key={player.id} className="player-card">
                                            <div className="player-name">{player.name}</div>
                                            <span className="player-role">{player.playerType || 'Player'}</span>
                                            <div className="player-stats">
                                                <div className="stat">
                                                    <span className="stat-label">Credits</span>
                                                    <span className="stat-value">{player.credits || 0}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="team-section">
                                <div className="team-header">
                                    {parseTeamNames(selectedMatch.id)[1]} - Squad ({players.team2.length} players)
                                </div>
                                <div className="players-grid">
                                    {players.team2.map(player => (
                                        <div key={player.id} className="player-card">
                                            <div className="player-name">{player.name}</div>
                                            <span className="player-role">{player.playerType || 'Player'}</span>
                                            <div className="player-stats">
                                                <div className="stat">
                                                    <span className="stat-label">Credits</span>
                                                    <span className="stat-value">{player.credits || 0}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <h2>üèè All Matches</h2>
                    
                    {matches.length === 0 ? (
                        <p style={{ textAlign: 'center', color: '#9ca3af', padding: '40px' }}>
                            No matches available yet.
                        </p>
                    ) : (
                        <div className="match-list">
                            {matches.map(match => (
                                <div 
                                    key={match.id} 
                                    className="match-card"
                                    onClick={() => setSelectedMatch(match)}
                                >
                                    <div className="match-header">
                                        <div className="teams">{match.id}</div>
                                        <span className={`status-badge status-${match.status || 'upcoming'}`}>
                                            {(match.status || 'upcoming').toUpperCase()}
                                        </span>
                                    </div>
                                    
                                    <div className="match-info">
                                        <div className="info-item">
                                            <span className="info-label">Match #</span>
                                            <span className="info-value">
                                                {match['match#'] || 'TBD'}
                                            </span>
                                        </div>
                                        <div className="info-item">
                                            <span className="info-label">Date & Time</span>
                                            <span className="info-value">
                                                {match.matchtime ? new Date(match.matchtime.seconds * 1000).toLocaleString() : 'TBD'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    </div>
                </div>
            );
        }

        function LeaderboardTab() {
            const [leaderboard, setLeaderboard] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadLeaderboard();
            }, []);

            const loadLeaderboard = async () => {
                try {
                    const { collection, getDocs, orderBy, query } = window.firebaseModules;
                    const leaderboardRef = collection(window.firebaseDb, 'leaderboard');
                    const q = query(leaderboardRef, orderBy('totalPoints', 'desc'));
                    const snapshot = await getDocs(q);
                    
                    const leaderboardData = snapshot.docs.map((doc, index) => ({
                        id: doc.id,
                        rank: index + 1,
                        ...doc.data()
                    }));
                    
                    setLeaderboard(leaderboardData);
                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="card"><div className="loading">Loading leaderboard...</div></div>;
            }

            return (
                <div className="card">
                    <h2>üèÜ Leaderboard</h2>
                    
                    {leaderboard.length === 0 ? (
                        <p style={{ textAlign: 'center', color: '#9ca3af', padding: '40px' }}>
                            No players on the leaderboard yet. Join a match to get started!
                        </p>
                    ) : (
                        <table className="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Matches Joined</th>
                                    <th>Matches Played</th>
                                    <th>Total Points</th>
                                </tr>
                            </thead>
                            <tbody>
                                {leaderboard.map(entry => (
                                    <tr key={entry.id}>
                                        <td>
                                            <span className={`rank rank-${entry.rank}`}>
                                                #{entry.rank}
                                            </span>
                                        </td>
                                        <td>{entry.userEmail}</td>
                                        <td>{entry.matchesJoined || 0}</td>
                                        <td>{entry.matchesPlayed || 0}</td>
                                        <td>
                                            <span className="points-highlight">
                                                {entry.totalPoints || 0}
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                    </div>
                </div>
            );
        }

        function AdminTab() {
            const [matches, setMatches] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [players, setPlayers] = useState([]);
            const [playerScores, setPlayerScores] = useState({});
            const [loading, setLoading] = useState(true);

            // Team name mapping
            const teamNameMap = {
                'Ind': 'India', 'Pak': 'Pakistan', 'Aus': 'Australia', 'Eng': 'England',
                'NZ': 'New Zealand', 'SA': 'South Africa', 'WI': 'West Indies',
                'SL': 'Sri Lanka', 'Ban': 'Bangladesh', 'Afg': 'Afghanistan',
                'Ire': 'Ireland', 'Sco': 'Scotland', 'Zim': 'Zimbabwe',
                'USA': 'USA', 'Can': 'Canada', 'Ned': 'Netherlands',
                'Nam': 'Namibia', 'PNG': 'Papua New Guinea', 'Oma': 'Oman',
                'UAE': 'UAE', 'Nep': 'Nepal'
            };

            // Parse team names from match ID
            const parseTeamNames = (matchId) => {
                const parts = matchId.split(' vs ');
                if (parts.length !== 2) return [matchId, ''];
                return parts.map(abbr => teamNameMap[abbr.trim()] || abbr.trim());
            };

                        useEffect(() => {
                loadMatches();
            }, []);

            const loadMatches = async () => {
                try {
                    const { collection, getDocs, orderBy, query } = window.firebaseModules;
                    const matchesRef = collection(window.firebaseDb, 'matches');
                    const q = query(matchesRef, orderBy('matchtime', 'asc'));
                    const snapshot = await getDocs(q);
                    
                    const matchesList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    setMatches(matchesList);
                } catch (error) {
                    console.error('Error loading matches:', error);
                } finally {
                    setLoading(false);
                }
            };

            const loadMatchPlayers = async (match) => {
                try {
                    const { collection, getDocs } = window.firebaseModules;
                    
                    // Parse team names from match ID
                    const [team1Name, team2Name] = parseTeamNames(match.id);
                    
                    if (!team1Name || !team2Name) {
                        alert('Cannot parse team names from match!');
                        return;
                    }
                    
                    // Fetch players from teams/{teamName}/playerName collection
                    const team1PlayersRef = collection(window.firebaseDb, 'teams', team1Name, 'playerName');
                    const team2PlayersRef = collection(window.firebaseDb, 'teams', team2Name, 'playerName');
                    
                    const [team1Snapshot, team2Snapshot] = await Promise.all([
                        getDocs(team1PlayersRef),
                        getDocs(team2PlayersRef)
                    ]);
                    
                    const allPlayers = [
                        ...team1Snapshot.docs.map(doc => ({ 
                            id: doc.id, 
                            name: doc.id,
                            team: team1Name,
                            ...doc.data() 
                        })),
                        ...team2Snapshot.docs.map(doc => ({ 
                            id: doc.id,
                            name: doc.id,
                            team: team2Name,
                            ...doc.data() 
                        }))
                    ];
                    
                    if (allPlayers.length === 0) {
                        alert('No player data available for these teams yet!');
                        return;
                    }

                    setPlayers(allPlayers);
                    setSelectedMatch(match);
                    
                    // Initialize scores
                    const scores = {};
                    allPlayers.forEach(player => {
                        scores[player.id] = { runs: 0, wickets: 0, catches: 0, bonus: 0 };
                    });
                    setPlayerScores(scores);
                } catch (error) {
                    console.error('Error loading players:', error);
                    alert('Error loading players. Please try again.');
                }
            };

            const updatePlayerScore = (playerId, field, value) => {
                setPlayerScores(prev => ({
                    ...prev,
                    [playerId]: {
                        ...prev[playerId],
                        [field]: parseInt(value) || 0
                    }
                }));
            };

            const calculatePoints = (score) => {
                const { runs = 0, wickets = 0, catches = 0, bonus = 0 } = score;
                return (runs * 1) + (wickets * 25) + (catches * 8) + bonus;
            };

            const saveMatchResults = async () => {
                if (!selectedMatch) return;

                try {
                    const { writeBatch, doc, collection, query, where, getDocs, getDoc, updateDoc } = window.firebaseModules;
                    const batch = writeBatch(window.firebaseDb);

                    // 1. Save player match points
                    for (const playerId in playerScores) {
                        const score = playerScores[playerId];
                        const points = calculatePoints(score);
                        
                        const scoreRef = doc(window.firebaseDb, 'playerMatchPoints', `${selectedMatch.id}_${playerId}`);
                        batch.set(scoreRef, {
                            matchId: selectedMatch.id,
                            playerId: playerId,
                            runs: score.runs,
                            wickets: score.wickets,
                            catches: score.catches,
                            bonus: score.bonus || 0,
                            totalPoints: points,
                            updatedAt: new Date().toISOString()
                        });
                    }

                    // 2. Mark match as completed
                    const matchRef = doc(window.firebaseDb, 'matches', selectedMatch.id);
                    batch.update(matchRef, {
                        status: 'completed',
                        completedAt: new Date().toISOString()
                    });

                    await batch.commit();

                    // 3. Update leaderboard for all participants
                    await updateLeaderboard(selectedMatch.id);

                    alert('Match results saved and leaderboard updated!');
                    setSelectedMatch(null);
                    loadMatches();
                } catch (error) {
                    console.error('Error saving results:', error);
                    alert('Failed to save results');
                }
            };

            const updateLeaderboard = async (matchId) => {
                try {
                    const { collection, query, where, getDocs, doc, getDoc, updateDoc } = window.firebaseModules;
                    
                    // Get all participants for this match
                    const participantsRef = collection(window.firebaseDb, 'matchParticipation');
                    const q = query(participantsRef, where('matchId', '==', matchId));
                    const participantsSnapshot = await getDocs(q);

                    for (const participantDoc of participantsSnapshot.docs) {
                        const participant = participantDoc.data();
                        const userId = participant.userId;

                        // Calculate total points from all players in this match
                        let totalMatchPoints = 0;
                        
                        for (const playerId in playerScores) {
                            const points = calculatePoints(playerScores[playerId]);
                            totalMatchPoints += points;
                        }

                        // Update leaderboard
                        const leaderboardRef = doc(window.firebaseDb, 'leaderboard', userId);
                        const leaderboardDoc = await getDoc(leaderboardRef);
                        
                        if (leaderboardDoc.exists()) {
                            const currentData = leaderboardDoc.data();
                            await updateDoc(leaderboardRef, {
                                totalPoints: (currentData.totalPoints || 0) + totalMatchPoints,
                                matchesPlayed: (currentData.matchesPlayed || 0) + 1,
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error updating leaderboard:', error);
                }
            };

            if (loading) {
                return (
                    <div className="card">
                        <h2>‚öôÔ∏è Admin Panel</h2>
                        <div className="loading">Loading...</div>
                    </div>
                );
            }

            if (selectedMatch) {
                return (
                    <div className="card">
                        <button 
                            onClick={() => setSelectedMatch(null)} 
                            className="btn btn-secondary" 
                            style={{ marginBottom: '20px' }}
                        >
                            ‚Üê Back to Matches
                        </button>

                        <h2>Enter Match Results: {selectedMatch.id}</h2>
                        
                        <div className="admin-section">
                            <h3>Player Scores</h3>
                            
                            {players.map(player => (
                                <div key={player.id} className="player-score-input">
                                    <div style={{ fontWeight: '600' }}>
                                        {player.name} ({player.team})
                                    </div>
                                    <input
                                        type="number"
                                        placeholder="Runs"
                                        value={playerScores[player.id]?.runs || 0}
                                        onChange={(e) => updatePlayerScore(player.id, 'runs', e.target.value)}
                                    />
                                    <input
                                        type="number"
                                        placeholder="Wickets"
                                        value={playerScores[player.id]?.wickets || 0}
                                        onChange={(e) => updatePlayerScore(player.id, 'wickets', e.target.value)}
                                    />
                                    <input
                                        type="number"
                                        placeholder="Catches"
                                        value={playerScores[player.id]?.catches || 0}
                                        onChange={(e) => updatePlayerScore(player.id, 'catches', e.target.value)}
                                    />
                                    <input
                                        type="number"
                                        placeholder="Bonus"
                                        value={playerScores[player.id]?.bonus || 0}
                                        onChange={(e) => updatePlayerScore(player.id, 'bonus', e.target.value)}
                                    />
                                    <div style={{ fontWeight: '700', color: '#10b981' }}>
                                        {calculatePoints(playerScores[player.id] || {})} pts
                                    </div>
                                </div>
                            ))}

                            <button 
                                onClick={saveMatchResults} 
                                className="btn" 
                                style={{ marginTop: '20px', width: '100%' }}
                            >
                                Save Results & Update Leaderboard
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <h2>‚öôÔ∏è Admin Panel</h2>
                    
                    <div className="admin-section">
                        <h3>Manage Match Results</h3>
                        <div className="match-list">
                            {matches.map(match => (
                                <div key={match.id} className="match-card">
                                    <div className="match-header">
                                        <div className="teams">{match.id}</div>
                                        <span className={`status-badge status-${match.status || 'upcoming'}`}>
                                            {(match.status || 'upcoming').toUpperCase()}
                                        </span>
                                    </div>
                                    <button 
                                        onClick={() => loadMatchPlayers(match)}
                                        className="btn"
                                        style={{ width: '100%', marginTop: '15px' }}
                                    >
                                        Enter Results
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
