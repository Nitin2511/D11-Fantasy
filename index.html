<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T20 World Cup 2026 Fantasy League</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, addDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDacks7Qnk42D2898leU_kgG8DZsYTFxCw",
            authDomain: "t20-fantasy-contest.firebaseapp.com",
            projectId: "t20-fantasy-contest",
            storageBucket: "t20-fantasy-contest.firebasestorage.app",
            messagingSenderId: "180217303236",
            appId: "1:180217303236:web:a6b078a7a7d0fa070c3991",
            measurementId: "G-LYY944KN99"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            collection, query, where, getDocs, addDoc, orderBy,
            signInWithEmailAndPassword, createUserWithEmailAndPassword,
            signOut, onAuthStateChanged, Timestamp
        };
        window.firebaseReady = true;
        
        console.log("‚úÖ Firebase initialized");
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Exo 2', sans-serif;
            background: #0a0e1a;
            color: #e0e6ed;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                linear-gradient(180deg, #0a0e1a 0%, #0f1729 100%);
            pointer-events: none;
            z-index: 0;
        }
        
        #root {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
            padding: 40px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .user-badge {
            position: absolute;
            top: 20px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 25px;
            background: #1a1f2e;
            border: 2px solid transparent;
            border-radius: 12px;
            color: #8b92a7;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: #10b981;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .card {
            background: #151a2b;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid #2a3142;
        }

        .card h2 {
            font-family: 'Orbitron', sans-serif;
            color: #10b981;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        .match-list { display: grid; gap: 20px; }

        .match-card {
            background: #1a1f2e;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #2a3142;
            cursor: pointer;
            transition: all 0.3s;
        }

        .match-card:hover {
            border-color: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .teams {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #e0e6ed;
        }

        .match-info {
            display: flex;
            gap: 20px;
            color: #8b92a7;
            font-size: 0.95rem;
            flex-wrap: wrap;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .player-card {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #2a3142;
            cursor: pointer;
            transition: all 0.3s;
        }

        .player-card:hover { border-color: #10b981; }

        .player-card.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
        }

        .player-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #e0e6ed;
        }

        .player-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-role {
            background: #2a3142;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #10b981;
            font-weight: 600;
        }

        .player-credits {
            color: #10b981;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .player-team {
            font-size: 0.9rem;
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .captain-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .captain-btn {
            flex: 1;
            padding: 8px;
            background: #2a3142;
            border: none;
            border-radius: 8px;
            color: #8b92a7;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .captain-btn.active-captain {
            background: #10b981;
            color: white;
        }

        .captain-btn.active-vc {
            background: #3b82f6;
            color: white;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .team-summary {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #2a3142;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-item { text-align: center; }

        .summary-label {
            font-size: 0.9rem;
            color: #8b92a7;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        .validation-errors {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .validation-errors h4 {
            color: #ef4444;
            margin-bottom: 10px;
        }

        .validation-errors ul {
            margin-left: 20px;
            color: #fca5a5;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.2rem;
            color: #8b92a7;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-card {
            background: #151a2b;
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 100%;
            border: 1px solid #2a3142;
        }

        .auth-card h2 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: #10b981;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #8b92a7;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            background: #1a1f2e;
            border: 2px solid #2a3142;
            border-radius: 8px;
            color: #e0e6ed;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #10b981;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #8b92a7;
            font-size: 0.9rem;
        }

        .role-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .role-tab {
            padding: 10px 20px;
            background: #1a1f2e;
            border: 2px solid #2a3142;
            border-radius: 8px;
            color: #8b92a7;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .role-tab.active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            background: #1a1f2e;
            border: 2px solid #2a3142;
            border-radius: 10px;
            color: #e0e6ed;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .search-box:focus {
            outline: none;
            border-color: #10b981;
        }

        .admin-badge {
            background: #ef4444;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 10px;
            font-weight: 700;
        }

        .error-display {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success-display {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #6ee7b7;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #93c5fd;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .user-badge, .logout-btn {
                position: static;
                display: block;
                margin: 10px auto;
                width: fit-content;
            }
            .players-grid { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const checkAuth = setInterval(() => {
                    if (window.firebaseReady) {
                        clearInterval(checkAuth);
                        
                        const { onAuthStateChanged } = window.firebaseModules;
                        
                        onAuthStateChanged(window.firebaseAuth, async (firebaseUser) => {
                            if (firebaseUser) {
                                try {
                                    const { collection, query, where, getDocs } = window.firebaseModules;
                                    const usersRef = collection(window.firebaseDb, 'users');
                                    const q = query(usersRef, where('email', '==', firebaseUser.email));
                                    const querySnapshot = await getDocs(q);
                                    
                                    if (!querySnapshot.empty) {
                                        const userData = querySnapshot.docs[0].data();
                                        setUser({
                                            ...firebaseUser,
                                            ...userData,
                                            uid: firebaseUser.uid
                                        });
                                    } else {
                                        setUser(firebaseUser);
                                    }
                                } catch (error) {
                                    console.error('Error loading user data:', error);
                                    setUser(firebaseUser);
                                }
                            } else {
                                setUser(null);
                            }
                            setLoading(false);
                        });
                    }
                }, 100);

                return () => clearInterval(checkAuth);
            }, []);

            const handleAuth = async (e) => {
                e.preventDefault();
                const username = e.target.username.value.trim();
                const password = e.target.password.value;

                if (!username || !password) {
                    alert('Please enter both username and password');
                    return;
                }

                try {
                    const { collection, query, where, getDocs, signInWithEmailAndPassword, createUserWithEmailAndPassword } = window.firebaseModules;
                    
                    console.log('üîç Looking up user:', username);
                    
                    // Search for user in Firestore
                    const usersRef = collection(window.firebaseDb, 'users');
                    const q = query(usersRef, where('username', '==', username));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        console.error('‚ùå User not found in Firestore');
                        alert('User not found. Please check your username or contact admin.');
                        return;
                    }
                    
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    console.log('‚úÖ User found in Firestore:', userData.username);
                    
                    // Verify password matches Firestore
                    if (userData.password !== password) {
                        console.error('‚ùå Password mismatch');
                        alert('Incorrect password. Please try again.');
                        return;
                    }
                    
                    console.log('‚úÖ Password verified');
                    
                    // Generate email if not present
                    const email = userData.email || `${username}@fantasy-cricket.local`;
                    
                    console.log('üìß Using email:', email);
                    
                    // Try to sign in to Firebase Auth
                    try {
                        await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                        console.log('‚úÖ Signed in with existing Firebase Auth account');
                    } catch (signInError) {
                        console.log('‚ö†Ô∏è Firebase Auth account not found:', signInError.code);
                        
                        if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/wrong-password') {
                            // Create new Firebase Auth account
                            console.log('üî® Creating new Firebase Auth account...');
                            try {
                                const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                                console.log('‚úÖ Firebase Auth account created successfully');
                                
                                // Update display name if available
                                if (userData.name && userCredential.user.updateProfile) {
                                    await userCredential.user.updateProfile({
                                        displayName: userData.name
                                    });
                                }
                            } catch (createError) {
                                console.error('‚ùå Error creating Firebase Auth account:', createError);
                                
                                if (createError.code === 'auth/email-already-in-use') {
                                    // Email exists but password doesn't match - try signing in again
                                    console.log('üîÑ Email exists, retrying sign in...');
                                    await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                                } else {
                                    throw createError;
                                }
                            }
                        } else {
                            throw signInError;
                        }
                    }
                    
                    console.log('üéâ Login successful!');
                    
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    let errorMessage = 'Login failed. Please try again.';
                    
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email format. Contact admin.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password must be at least 6 characters.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Check your connection.';
                    }
                    
                    alert(errorMessage);
                }
            };

            const handleLogout = async () => {
                const { signOut } = window.firebaseModules;
                await signOut(window.firebaseAuth);
            };

            if (loading) {
                return <div className="loading">Loading...</div>;
            }

            if (!user) {
                return (
                    <div className="auth-container">
                        <div className="auth-card">
                            <h2>üèè LOGIN</h2>
                            
                            <div className="info-box">
                                <strong>‚ÑπÔ∏è For New Users:</strong> Use your Firestore username and password. Account will be created automatically on first login.
                            </div>
                            
                            <form onSubmit={handleAuth}>
                                <div className="form-group">
                                    <label>Username</label>
                                    <input 
                                        type="text" 
                                        name="username" 
                                        required 
                                        autoComplete="username"
                                        placeholder="Enter your username"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Password</label>
                                    <input 
                                        type="password" 
                                        name="password" 
                                        required 
                                        placeholder="Enter your password"
                                    />
                                </div>
                                <button type="submit" className="btn" style={{ width: '100%' }}>
                                    Login
                                </button>
                            </form>
                            <div className="auth-toggle">
                                Contact admin to add you to Firestore
                            </div>
                        </div>
                    </div>
                );
            }

            return <Dashboard user={user} onLogout={handleLogout} />;
        }

        function Dashboard({ user, onLogout }) {
            const [activeTab, setActiveTab] = useState('matches');

            return (
                <>
                    <div className="header">
                        <div className="user-badge">
                            üë§ {user.username || user.email}
                            {user.role === 'admin' && <span className="admin-badge">Admin</span>}
                        </div>
                        <h1>‚ö° T20 WORLD CUP 2026</h1>
                        <button className="logout-btn" onClick={onLogout}>Logout</button>
                    </div>

                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'matches' ? 'active' : ''}`}
                            onClick={() => setActiveTab('matches')}
                        >
                            üèè Matches
                        </button>
                        <button 
                            className={`tab ${activeTab === 'my-teams' ? 'active' : ''}`}
                            onClick={() => setActiveTab('my-teams')}
                        >
                            üë• My Teams
                        </button>
                    </div>

                    {activeTab === 'matches' && <MatchesTab user={user} />}
                    {activeTab === 'my-teams' && <MyTeamsTab user={user} />}
                </>
            );
        }

        function MatchesTab({ user }) {
            const [matches, setMatches] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadMatches();
            }, []);

            const loadMatches = async () => {
                try {
                    const { collection, getDocs, orderBy, query } = window.firebaseModules;
                    const matchesRef = collection(window.firebaseDb, 'matches');
                    const q = query(matchesRef, orderBy('match#', 'asc'));
                    const snapshot = await getDocs(q);
                    
                    const matchesData = [];
                    snapshot.forEach(doc => {
                        matchesData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    setMatches(matchesData);
                } catch (error) {
                    console.error('Error loading matches:', error);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="card"><div className="loading">Loading matches...</div></div>;
            }

            if (selectedMatch) {
                return <TeamBuilder match={selectedMatch} user={user} onBack={() => setSelectedMatch(null)} />;
            }

            return (
                <div className="card">
                    <h2>Select a Match</h2>
                    <div className="match-list">
                        {matches.map(match => (
                            <div 
                                key={match.id} 
                                className="match-card"
                                onClick={() => setSelectedMatch(match)}
                            >
                                <div className="match-header">
                                    <div className="teams">{match.id}</div>
                                </div>
                                <div className="match-info">
                                    <span>üìÖ {match.matchtime?.toDate?.()?.toLocaleDateString() || 'TBD'}</span>
                                    <span>‚è∞ {match.matchtime?.toDate?.()?.toLocaleTimeString() || 'TBD'}</span>
                                    <span>üìç Match #{match['match#']}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // [TeamBuilder and MyTeamsTab components remain the same as in the previous version]
        // ... (keeping the code from the previous fixed version for these components)

        function TeamBuilder({ match, user, onBack }) {
            const [players, setPlayers] = useState([]);
            const [selectedPlayers, setSelectedPlayers] = useState([]);
            const [captain, setCaptain] = useState(null);
            const [viceCaptain, setViceCaptain] = useState(null);
            const [activeRole, setActiveRole] = useState('ALL');
            const [searchTerm, setSearchTerm] = useState('');
            const [loading, setLoading] = useState(true);
            const [validationErrors, setValidationErrors] = useState([]);
            const [errorMsg, setErrorMsg] = useState('');

            useEffect(() => {
                loadPlayers();
            }, [match]);

            const loadPlayers = async () => {
                try {
                    setErrorMsg('');
                    const matchTeams = match.id.split(' vs ').map(t => t.trim());
                    const allPlayers = [];
                    
                    for (const teamName of matchTeams) {
                        try {
                            const { collection, getDocs } = window.firebaseModules;
                            const teamRef = collection(window.firebaseDb, 'teams', teamName, 'playerName');
                            const snapshot = await getDocs(teamRef);
                            
                            snapshot.forEach(doc => {
                                try {
                                    const playerData = doc.data();
                                    const playerId = String(doc.id || '').trim();
                                    const credits = parseFloat(playerData.credits) || 10;
                                    const playerType = String(playerData.playerType || 'Batter').trim();
                                    
                                    allPlayers.push({
                                        id: playerId,
                                        name: playerId,
                                        team: teamName,
                                        credits: Math.max(5, Math.min(15, credits)),
                                        playerType: playerType,
                                        role: mapPlayerTypeToRole(playerType)
                                    });
                                } catch (playerError) {
                                    console.warn('Error processing player:', doc.id, playerError);
                                }
                            });
                        } catch (teamError) {
                            console.error(`Error loading team ${teamName}:`, teamError);
                        }
                    }
                    
                    if (allPlayers.length === 0) {
                        setErrorMsg('No players found. Please check Firestore data.');
                    }
                    
                    setPlayers(allPlayers);
                } catch (error) {
                    console.error('Error loading players:', error);
                    setErrorMsg('Failed to load players.');
                } finally {
                    setLoading(false);
                }
            };

            const mapPlayerTypeToRole = (playerType) => {
                if (!playerType) return 'BAT';
                const type = String(playerType).toLowerCase();
                if (type.includes('keeper') || type.includes('wk')) return 'WK';
                if (type.includes('all')) return 'AR';
                if (type.includes('bowl')) return 'BOWL';
                return 'BAT';
            };

            const validateTeam = () => {
                const errors = [];
                if (selectedPlayers.length !== 11) errors.push(`Select exactly 11 players (currently ${selectedPlayers.length})`);
                
                const totalCredits = selectedPlayers.reduce((sum, p) => sum + (parseFloat(p.credits) || 10), 0);
                if (totalCredits > 100) errors.push(`Total credits ${totalCredits.toFixed(1)} exceeds limit of 100`);
                
                const roleCounts = {
                    WK: selectedPlayers.filter(p => p.role === 'WK').length,
                    BAT: selectedPlayers.filter(p => p.role === 'BAT').length,
                    AR: selectedPlayers.filter(p => p.role === 'AR').length,
                    BOWL: selectedPlayers.filter(p => p.role === 'BOWL').length
                };
                
                if (roleCounts.WK < 1 || roleCounts.WK > 4) errors.push(`Select 1-4 WK (current: ${roleCounts.WK})`);
                if (roleCounts.BAT < 3 || roleCounts.BAT > 6) errors.push(`Select 3-6 BAT (current: ${roleCounts.BAT})`);
                if (roleCounts.AR < 1 || roleCounts.AR > 4) errors.push(`Select 1-4 AR (current: ${roleCounts.AR})`);
                if (roleCounts.BOWL < 3 || roleCounts.BOWL > 6) errors.push(`Select 3-6 BOWL (current: ${roleCounts.BOWL})`);
                
                const matchTeams = match.id.split(' vs ').map(t => t.trim());
                const teamCounts = {};
                matchTeams.forEach(t => teamCounts[t] = 0);
                selectedPlayers.forEach(p => { if (teamCounts[p.team] !== undefined) teamCounts[p.team]++; });
                Object.entries(teamCounts).forEach(([team, count]) => {
                    if (count > 7) errors.push(`Max 7 from ${team} (current: ${count})`);
                });
                
                if (!captain) errors.push('Select a Captain');
                if (!viceCaptain) errors.push('Select a Vice-Captain');
                if (captain && viceCaptain && captain === viceCaptain) errors.push('Captain and VC must be different');
                
                return errors;
            };

            const togglePlayer = (player) => {
                try {
                    const isSelected = selectedPlayers.find(p => p.id === player.id);
                    if (isSelected) {
                        setSelectedPlayers(selectedPlayers.filter(p => p.id !== player.id));
                        if (captain === player.id) setCaptain(null);
                        if (viceCaptain === player.id) setViceCaptain(null);
                    } else {
                        if (selectedPlayers.length < 11) setSelectedPlayers([...selectedPlayers, player]);
                    }
                    setValidationErrors([]);
                } catch (error) {
                    console.error('Error toggling player:', error);
                }
            };

            const saveTeam = async () => {
                const errors = validateTeam();
                if (errors.length > 0) {
                    setValidationErrors(errors);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
                
                try {
                    const { collection, addDoc, Timestamp } = window.firebaseModules;
                    const teamData = {
                        userId: user.uid,
                        matchId: match.id,
                        players: selectedPlayers.map(p => ({
                            id: String(p.id),
                            name: String(p.name),
                            team: String(p.team),
                            credits: parseFloat(p.credits),
                            role: String(p.role)
                        })),
                        captain: String(captain),
                        viceCaptain: String(viceCaptain),
                        totalCredits: selectedPlayers.reduce((sum, p) => sum + (parseFloat(p.credits) || 10), 0),
                        createdAt: Timestamp.now()
                    };
                    
                    await addDoc(collection(window.firebaseDb, 'userTeams'), teamData);
                    alert('‚úÖ Team saved successfully!');
                    onBack();
                } catch (error) {
                    console.error('Error saving team:', error);
                    alert('Error saving team: ' + error.message);
                }
            };

            const filteredPlayers = players.filter(player => {
                try {
                    const matchesRole = activeRole === 'ALL' || player.role === activeRole;
                    const matchesSearch = String(player.name || '').toLowerCase().includes(searchTerm.toLowerCase());
                    return matchesRole && matchesSearch;
                } catch { return false; }
            });

            const getRoleCount = (role) => selectedPlayers.filter(p => p.role === role).length;
            const totalCredits = selectedPlayers.reduce((sum, p) => sum + (parseFloat(p.credits) || 10), 0);

            if (loading) {
                return (
                    <div className="card">
                        <button onClick={onBack} className="btn" style={{ marginBottom: '20px' }}>‚Üê Back</button>
                        <div className="loading">Loading players...</div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <button onClick={onBack} className="btn" style={{ marginBottom: '20px' }}>‚Üê Back</button>
                    <h2>Create Team - {match.id}</h2>

                    {errorMsg && <div className="error-display"><strong>‚ö†Ô∏è</strong> {errorMsg}</div>}
                    {validationErrors.length > 0 && (
                        <div className="validation-errors">
                            <h4>‚ö†Ô∏è Fix these issues:</h4>
                            <ul>{validationErrors.map((e, i) => <li key={i}>{e}</li>)}</ul>
                        </div>
                    )}

                    <div className="team-summary">
                        <div className="summary-grid">
                            <div className="summary-item">
                                <div className="summary-label">Players</div>
                                <div className="summary-value">{selectedPlayers.length}/11</div>
                            </div>
                            <div className="summary-item">
                                <div className="summary-label">Credits</div>
                                <div className="summary-value" style={{ color: totalCredits > 100 ? '#ef4444' : '#10b981' }}>
                                    {totalCredits.toFixed(1)}/100
                                </div>
                            </div>
                            <div className="summary-item">
                                <div className="summary-label">WK</div>
                                <div className="summary-value">{getRoleCount('WK')}</div>
                            </div>
                            <div className="summary-item">
                                <div className="summary-label">BAT</div>
                                <div className="summary-value">{getRoleCount('BAT')}</div>
                            </div>
                            <div className="summary-item">
                                <div className="summary-label">AR</div>
                                <div className="summary-value">{getRoleCount('AR')}</div>
                            </div>
                            <div className="summary-item">
                                <div className="summary-label">BOWL</div>
                                <div className="summary-value">{getRoleCount('BOWL')}</div>
                            </div>
                        </div>
                    </div>

                    <input
                        type="text"
                        className="search-box"
                        placeholder="Search players..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />

                    <div className="role-tabs">
                        {['ALL', 'WK', 'BAT', 'AR', 'BOWL'].map(role => (
                            <div key={role} className={`role-tab ${activeRole === role ? 'active' : ''}`} onClick={() => setActiveRole(role)}>
                                {role}
                            </div>
                        ))}
                    </div>

                    <div className="players-grid">
                        {filteredPlayers.map(player => {
                            try {
                                const isSelected = selectedPlayers.find(p => p.id === player.id);
                                const isCaptain = captain === player.id;
                                const isVC = viceCaptain === player.id;
                                const canSelect = selectedPlayers.length < 11 || isSelected;
                                
                                return (
                                    <div
                                        key={player.id}
                                        className={`player-card ${isSelected ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}`}
                                        onClick={() => canSelect && togglePlayer(player)}
                                    >
                                        <div className="player-name">{player.name}</div>
                                        <div className="player-team">{player.team}</div>
                                        <div className="player-meta">
                                            <span className="player-role">{player.role}</span>
                                            <span className="player-credits">{player.credits} Cr</span>
                                        </div>
                                        
                                        {isSelected && (
                                            <div className="captain-buttons" onClick={(e) => e.stopPropagation()}>
                                                <button
                                                    className={`captain-btn ${isCaptain ? 'active-captain' : ''}`}
                                                    onClick={() => setCaptain(player.id)}
                                                >
                                                    {isCaptain ? 'üëë C (2x)' : 'Captain'}
                                                </button>
                                                <button
                                                    className={`captain-btn ${isVC ? 'active-vc' : ''}`}
                                                    onClick={() => setViceCaptain(player.id)}
                                                >
                                                    {isVC ? '‚≠ê VC (1.5x)' : 'VC'}
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            } catch { return null; }
                        })}
                    </div>

                    <button onClick={saveTeam} className="btn" style={{ width: '100%', marginTop: '30px' }}>
                        Save Team
                    </button>
                </div>
            );
        }

        function MyTeamsTab({ user }) {
            const [teams, setTeams] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadTeams();
            }, [user]);

            const loadTeams = async () => {
                try {
                    const { collection, query, where, getDocs } = window.firebaseModules;
                    const teamsRef = collection(window.firebaseDb, 'userTeams');
                    const q = query(teamsRef, where('userId', '==', user.uid));
                    const snapshot = await getDocs(q);
                    
                    const teamsData = [];
                    snapshot.forEach(doc => {
                        teamsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    setTeams(teamsData);
                } catch (error) {
                    console.error('Error loading teams:', error);
                } finally {
                    setLoading(false);
                }
            };

            if (loading) {
                return <div className="card"><div className="loading">Loading...</div></div>;
            }

            return (
                <div className="card">
                    <h2>My Teams</h2>
                    {teams.length === 0 ? (
                        <p style={{ textAlign: 'center', padding: '40px', color: '#8b92a7' }}>
                            No teams yet. Create your first team!
                        </p>
                    ) : (
                        <div className="match-list">
                            {teams.map(team => (
                                <div key={team.id} className="match-card">
                                    <div className="match-header">
                                        <div className="teams">{team.matchId}</div>
                                    </div>
                                    <div className="match-info">
                                        <span>Credits: {team.totalCredits?.toFixed(1)}</span>
                                        <span>{team.players?.length} Players</span>
                                    </div>
                                    <div style={{ marginTop: '15px' }}>
                                        <strong style={{ color: '#10b981' }}>Players:</strong>
                                        <div style={{ marginTop: '10px', display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: '10px' }}>
                                            {team.players?.map(p => (
                                                <div key={p.id} style={{ background: '#1a1f2e', padding: '8px', borderRadius: '6px' }}>
                                                    {p.name}
                                                    {p.id === team.captain && ' üëë'}
                                                    {p.id === team.viceCaptain && ' ‚≠ê'}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
